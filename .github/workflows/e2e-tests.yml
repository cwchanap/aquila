name: E2E Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  BUN_VERSION: "1.1.26"
  NODE_VERSION: "22"
  SUPABASE_CLI_VERSION: "2.70.5"
  PLAYWRIGHT_BROWSERS_PATH: "0"
  TURBO_TELEMETRY_DISABLED: "1"
  CI: "true"

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SUPABASE_E2E_EMAIL: ${{ secrets.SUPABASE_E2E_EMAIL }}
      SUPABASE_E2E_PASSWORD: ${{ secrets.SUPABASE_E2E_PASSWORD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Install Playwright browsers
        working-directory: packages/e2e
        run: bunx playwright install --with-deps

      - name: Start Supabase (local)
        run: |
          supabase init --force
          supabase start

      - name: Export Supabase env
        run: |
          eval "$(supabase status -o env)"
          echo "API_URL=${API_URL}" >> $GITHUB_ENV
          echo "DB_URL=${DB_URL}" >> $GITHUB_ENV
          echo "ANON_KEY=${ANON_KEY}" >> $GITHUB_ENV
          echo "SERVICE_ROLE_KEY=${SERVICE_ROLE_KEY}" >> $GITHUB_ENV
          # Map CLI output to vars used by the app
          echo "SUPABASE_URL=${API_URL}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${ANON_KEY}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${SERVICE_ROLE_KEY}" >> $GITHUB_ENV
          echo "PUBLIC_SUPABASE_URL=${API_URL}" >> $GITHUB_ENV
          echo "PUBLIC_SUPABASE_ANON_KEY=${ANON_KEY}" >> $GITHUB_ENV
          echo "DATABASE_URL=${DB_URL}" >> $GITHUB_ENV

      - name: Ensure shared Supabase E2E user exists
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          bun -e "import { createClient } from '@supabase/supabase-js';
          const url = process.env.SUPABASE_URL;
          const key = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const email = process.env.SUPABASE_E2E_EMAIL;
          const password = process.env.SUPABASE_E2E_PASSWORD;
          if (!url || !key || !email || !password) {
            console.error('Missing SUPABASE_URL/SUPABASE_SERVICE_ROLE_KEY/SUPABASE_E2E_EMAIL/SUPABASE_E2E_PASSWORD');
            process.exit(1);
          }
          const supabase = createClient(url, key, { auth: { persistSession: false } });
          const { error } = await supabase.auth.admin.createUser({ email, password, email_confirm: true });
          if (error) {
            const status = error.status;
            const code = error.code;
            const isDuplicate =
              (status === 422 || status === 409) &&
              (code === 'email_exists' || code === 'user_already_exists');
            if (!isDuplicate) {
              console.error({ message: error.message, status, code, name: error.name });
              process.exit(1);
            }
          }
          console.log('âœ… Supabase E2E user ensured');"

      - name: Run database migrations
        working-directory: apps/web
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: bun run drizzle:migrate

      - name: Run Playwright tests
        working-directory: packages/e2e
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        run: bun run test:e2e
