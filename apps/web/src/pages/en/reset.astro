---
import MainLayout from '../../layouts/main.astro';
import { getTranslations } from '@aquila/dialogue';

const locale = Astro.currentLocale === 'zh' ? 'zh' : 'en';
const translations = getTranslations(locale);
const resetStrings = translations.auth.resetPage;
---

<MainLayout title={resetStrings.title}>
  <div class="min-h-screen flex items-center justify-center bg-slate-100">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
      <h1 class="text-2xl font-bold text-slate-800 mb-4" id="reset-heading">
        {resetStrings.heading}
      </h1>
      <p class="text-sm text-slate-600 mb-6" id="reset-subtitle">
        {resetStrings.subtitle}
      </p>

      <form id="reset-form" class="space-y-4">
        <div>
          <label for="new-password" class="block text-sm font-semibold text-slate-700 mb-2">
            {resetStrings.newPasswordLabel}
          </label>
          <input
            id="new-password"
            name="new-password"
            type="password"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-200 outline-none"
            placeholder={resetStrings.newPasswordPlaceholder}
          />
        </div>
        <div>
          <label for="confirm-password" class="block text-sm font-semibold text-slate-700 mb-2">
            {resetStrings.confirmPasswordLabel}
          </label>
          <input
            id="confirm-password"
            name="confirm-password"
            type="password"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-200 outline-none"
            placeholder={resetStrings.confirmPasswordPlaceholder}
          />
        </div>
        <button
          type="submit"
          class="w-full bg-gradient-to-r from-blue-500 to-cyan-400 text-white font-semibold py-3 rounded-lg shadow-lg hover:shadow-xl transition disabled:opacity-60 disabled:cursor-not-allowed"
        >
          {resetStrings.submitButton}
        </button>
      </form>

      <div id="reset-error" class="hidden mt-4 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3"></div>
      <div id="reset-success" class="hidden mt-4 text-sm text-green-700 bg-green-50 border border-green-200 rounded-lg p-3"></div>
    </div>
  </div>

  <script define:vars={{ resetStrings }}>
    import { getSupabaseAuthClient } from '@/lib/auth';

    document.addEventListener('DOMContentLoaded', async () => {
      const form = document.getElementById('reset-form');
      const errorEl = document.getElementById('reset-error');
      const successEl = document.getElementById('reset-success');

      if (!(form instanceof HTMLFormElement)) return;
      if (!(errorEl instanceof HTMLElement)) return;
      if (!(successEl instanceof HTMLElement)) return;

      const submitButton = form.querySelector('button[type="submit"]');
      if (!(submitButton instanceof HTMLButtonElement)) return;

      const supabase = getSupabaseAuthClient();
      let sessionReady = false;

      submitButton.disabled = true;

      function showError(message) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
      }

      function hideError() {
        errorEl.classList.add('hidden');
      }

      function showSuccess(message) {
        successEl.textContent = message;
        successEl.classList.remove('hidden');
      }

      function hideSuccess() {
        successEl.classList.add('hidden');
      }

      async function initializeSessionFromHash() {
        sessionReady = false;
        submitButton.disabled = true;

        const hashParams = new URLSearchParams(window.location.hash.replace('#', ''));
        const access_token = hashParams.get('access_token');
        const refresh_token = hashParams.get('refresh_token');

        if (!access_token || !refresh_token) {
          showError(resetStrings.invalidOrMissingLink);
          submitButton.disabled = true;
          return;
        }

        try {
          const { error } = await supabase.auth.setSession({
            access_token,
            refresh_token,
          });

          if (error) {
            console.error('Session init error:', error);
            showError(resetStrings.startSessionFailed);
            sessionReady = false;
            submitButton.disabled = true;
            return;
          }

          sessionReady = true;
          submitButton.disabled = false;
        } catch (err) {
          console.error('Session init error:', err);
          showError(resetStrings.startSessionFailed);
          sessionReady = false;
          submitButton.disabled = true;
        }
      }

      await initializeSessionFromHash();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        hideSuccess();

        if (!sessionReady) {
          showError(resetStrings.sessionNotReady);
          return;
        }

        const newPasswordInput = form.querySelector('#new-password');
        const confirmPasswordInput = form.querySelector('#confirm-password');

        const newPassword = newPasswordInput instanceof HTMLInputElement ? newPasswordInput.value : '';
        const confirmPassword = confirmPasswordInput instanceof HTMLInputElement ? confirmPasswordInput.value : '';

        if (!newPassword || newPassword !== confirmPassword) {
          showError(resetStrings.passwordMismatch);
          return;
        }

        try {
          const { error } = await supabase.auth.updateUser({ password: newPassword });
          if (error) {
            console.error('Update password error:', error);
            showError(resetStrings.updatePasswordFailed);
            return;
          }

          showSuccess(resetStrings.updatePasswordSuccess);

          setTimeout(() => {
            window.location.href = `/${document.documentElement.lang || 'en'}/login`;
          }, 1200);
        } catch (err) {
          console.error('Update password error:', err);
          showError(resetStrings.updatePasswordFailed);
        }
      });
    });
  </script>
</MainLayout>
