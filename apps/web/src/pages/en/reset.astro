---
import MainLayout from '../../layouts/main.astro';
---

<MainLayout title="Reset Password">
  <div class="min-h-screen flex items-center justify-center bg-slate-100">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
      <h1 class="text-2xl font-bold text-slate-800 mb-4" id="reset-heading">
        Reset Password
      </h1>
      <p class="text-sm text-slate-600 mb-6" id="reset-subtitle">
        Set a new password for your account.
      </p>

      <form id="reset-form" class="space-y-4">
        <div>
          <label for="new-password" class="block text-sm font-semibold text-slate-700 mb-2">
            New Password
          </label>
          <input
            id="new-password"
            name="new-password"
            type="password"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-200 outline-none"
            placeholder="Enter new password"
          />
        </div>
        <div>
          <label for="confirm-password" class="block text-sm font-semibold text-slate-700 mb-2">
            Confirm Password
          </label>
          <input
            id="confirm-password"
            name="confirm-password"
            type="password"
            required
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-cyan-400 focus:ring-2 focus:ring-cyan-200 outline-none"
            placeholder="Confirm new password"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-linear-to-r from-blue-500 to-cyan-400 text-white font-semibold py-3 rounded-lg shadow-lg hover:shadow-xl transition disabled:opacity-60 disabled:cursor-not-allowed"
        >
          Update Password
        </button>
      </form>

      <div id="reset-error" class="hidden mt-4 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3"></div>
      <div id="reset-success" class="hidden mt-4 text-sm text-green-700 bg-green-50 border border-green-200 rounded-lg p-3"></div>
    </div>
  </div>

  <script>
    import { getSupabaseAuthClient } from '@/lib/auth';

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('reset-form') as HTMLFormElement | null;
      const errorEl = document.getElementById('reset-error') as HTMLElement | null;
      const successEl = document.getElementById('reset-success') as HTMLElement | null;
      const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement | null;

      if (!form || !errorEl || !successEl || !submitBtn) return;

      const supabase = getSupabaseAuthClient();
      let sessionReady = false;

      function showError(message: string) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
      }

      function hideError() {
        errorEl.classList.add('hidden');
      }

      function showSuccess(message: string) {
        successEl.textContent = message;
        successEl.classList.remove('hidden');
      }

      function hideSuccess() {
        successEl.classList.add('hidden');
      }

      async function initializeSessionFromHash() {
        const hashParams = new URLSearchParams(window.location.hash.replace('#', ''));
        const access_token = hashParams.get('access_token');
        const refresh_token = hashParams.get('refresh_token');

        if (!access_token || !refresh_token) {
          showError('Reset link is invalid or missing. Please request a new email.');
          submitBtn.disabled = true;
          return;
        }

        try {
          const { error } = await supabase.auth.setSession({
            access_token,
            refresh_token,
          });

          if (error) {
            showError(error.message || 'Unable to start reset session.');
            submitBtn.disabled = true;
            return;
          }

          sessionReady = true;
        } catch (err) {
          console.error('Session init error:', err);
          showError('Unable to start reset session.');
          submitBtn.disabled = true;
        }
      }

      initializeSessionFromHash();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        hideSuccess();

        if (!sessionReady) {
          showError('Reset session not ready. Please use the link from your email.');
          return;
        }

        const newPassword = (form.querySelector('#new-password') as HTMLInputElement)?.value ?? '';
        const confirmPassword = (form.querySelector('#confirm-password') as HTMLInputElement)?.value ?? '';

        if (!newPassword || newPassword !== confirmPassword) {
          showError('Passwords do not match.');
          return;
        }

        try {
          const { error } = await supabase.auth.updateUser({ password: newPassword });
          if (error) {
            showError(error.message || 'Failed to update password.');
            return;
          }

          showSuccess('Password updated. You can now log in with your new password.');

          setTimeout(() => {
            window.location.href = `/${document.documentElement.lang || 'en'}/login`;
          }, 1200);
        } catch (err) {
          console.error('Update password error:', err);
          showError('Failed to update password.');
        }
      });
    });
  </script>
</MainLayout>
