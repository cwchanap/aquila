---
import MainLayout from '@/layouts/main.astro';
import MainMenu from '@/components/MainMenu.svelte';
import { translations } from '@aquila/dialogue';

const locale = Astro.currentLocale || 'en';

const t = (key: string): string => {
    const keys = key.split('.');
    let value: Record<string, unknown> =
        locale === 'zh' ? translations.zh : translations.en;

    for (const segment of keys) {
        if (value && typeof value === 'object' && segment in value) {
            value = value[segment] as Record<string, unknown>;
        } else {
            return key;
        }
    }

    return typeof value === 'string' ? value : key;
};

const errorStrings = {
    connectionTitle: t('common.errors.connectionTitle'),
    connectionMessage: t('common.errors.connectionMessage'),
    retry: t('common.errors.retry'),
};

// Full Astro Component Syntax:
// https://docs.astro.build/basics/astro-components/
---

<MainLayout title={t('menu.title')}>
    <MainMenu client:load locale={Astro.currentLocale ?? 'en'} />

    <script define:vars={{ locale, errorStrings }}>
        window.__AQUILA_PAGE_DATA__ = { locale, errorStrings };
    </script>

    <script type="module">
        import { getCurrentUser } from '@/lib/auth';

        const pageData =
            typeof window !== 'undefined'
                ? window.__AQUILA_PAGE_DATA__ ?? {}
                : {};
        const locale = pageData.locale ?? 'en';
        const errorStrings =
            pageData.errorStrings ?? {
                connectionTitle: 'Connection error',
                connectionMessage: 'Unable to connect.',
                retry: 'Retry',
            };

        // Handle auth gating and language preference persistence
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check for saved language preference
                const savedLanguage = localStorage.getItem('aquila:language');
                const preferredLanguage =
                    savedLanguage && savedLanguage !== locale
                        ? savedLanguage
                        : null;

                const user = await getCurrentUser();
                if (!user) {
                    const redirectLocale =
                        preferredLanguage === 'en' || preferredLanguage === 'zh'
                            ? preferredLanguage
                            : locale;
                    window.location.href = `/${redirectLocale}/login`;
                    return;
                }

                // Check if we're on the root path
                if (window.location.pathname === '/') {
                    // If user has a Chinese preference, redirect to Chinese home
                    if (savedLanguage === 'zh') {
                        window.location.href = '/zh';
                        return;
                    }
                } else if (
                    savedLanguage === 'en' &&
                    window.location.pathname.startsWith('/zh')
                ) {
                    // If user has English preference and we're on Chinese, redirect to English
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                const container = document.querySelector('main') || document.body;
                const errorDiv = document.createElement('div');
                errorDiv.className =
                    'fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4';

                const modalDiv = document.createElement('div');
                modalDiv.className =
                    'bg-red-900/90 border border-red-500 rounded-lg p-6 max-w-md w-full shadow-2xl text-white';

                const title = document.createElement('h2');
                title.className = 'text-xl font-bold mb-2';
                title.textContent = errorStrings.connectionTitle;

                const message = document.createElement('p');
                message.className = 'mb-4 text-red-100';
                message.textContent = errorStrings.connectionMessage;

                const shouldShowDetails = import.meta.env.DEV;
                const details = document.createElement('pre');
                details.className =
                    'text-sm font-mono bg-black/50 p-2 rounded mb-4 overflow-x-auto whitespace-pre-wrap';
                details.textContent =
                    error instanceof Error ? error.message : String(error);

                const retryButton = document.createElement('button');
                retryButton.type = 'button';
                retryButton.className =
                    'w-full py-2 bg-red-600 hover:bg-red-500 rounded font-medium transition-colors';
                retryButton.textContent = errorStrings.retry;
                retryButton.addEventListener('click', () => {
                    window.location.reload();
                });

                modalDiv.appendChild(title);
                modalDiv.appendChild(message);
                if (shouldShowDetails) {
                    modalDiv.appendChild(details);
                }
                modalDiv.appendChild(retryButton);
                errorDiv.appendChild(modalDiv);
                container.appendChild(errorDiv);
            }
        });
    </script>
</MainLayout>