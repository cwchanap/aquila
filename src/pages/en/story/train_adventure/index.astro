---
import MainLayout from '@/layouts/main.astro';
import en from '../../../../translations/en.json';
import zh from '../../../../translations/zh.json';

// Helper function to get translations
const t = (key: string): string => {
  const locale = Astro.currentLocale || 'en';
  const keys = key.split('.');
  let value: Record<string, unknown> = locale === 'zh' ? zh : en;

  for (const k of keys) {
    if (value && typeof value === 'object' && k in value) {
      value = value[k] as Record<string, unknown>;
    } else {
      return key;
    }
  }

  return typeof value === 'string' ? value : key;
};
---

<MainLayout title={t("adventure.title")}>
  <div id="game-container" data-locale={Astro.currentLocale || 'zh'} class="w-full h-screen bg-black"></div>
</MainLayout>

<script>
  import Phaser from 'phaser';
  import { PreloadScene } from '@/game/PreloadScene';
  import { StoryScene } from '@/game/StoryScene';

  document.addEventListener('DOMContentLoaded', () => {
    const storyId = 'train_adventure';
    const container = document.getElementById('game-container');
    const defaultLocale = (container?.getAttribute('data-locale') || 'en');
    const locale = defaultLocale;

    const config = {
      type: Phaser.AUTO,
      width: window.innerWidth,
      height: window.innerHeight,
      parent: 'game-container',
      backgroundColor: '#2c3e50',
      scene: [PreloadScene, StoryScene],
      scale: {
        mode: Phaser.Scale.RESIZE,
        autoCenter: Phaser.Scale.CENTER_BOTH
      }
    };

    const game = new Phaser.Game(config);

    // Fetch character name from DB for this story, fallback to 'Player'
    async function fetchCharacterName(): Promise<string> {
      try {
        const res = await fetch(`/api/character-setup?storyId=${storyId}`, { credentials: 'include' });
        if (!res.ok) return 'Player';
        const data = await res.json();
        if (data && typeof data.characterName === 'string' && data.characterName.trim().length > 0) {
          return data.characterName.trim();
        }
      } catch (e) {
        console.warn('Failed to fetch character setup, using default name', e);
      }
      return 'Player';
    }

    fetchCharacterName().then((characterName) => {
      // Pass character name, locale, and storyId to the preload scene (it forwards to StoryScene)
      game.scene.start('PreloadScene', { characterName, locale, storyId });
    });
  });
</script>